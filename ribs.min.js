(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};(function(e){var n;return window.Ribs={},Ribs._boundJumpKeys={},Ribs._jumpPrefixKey="g",Ribs._jumpTimeout=1e3,Ribs._poiseJump=function(){return Ribs._readyToJump=!0,clearTimeout(Ribs._jumpInterval),Ribs._jumpInterval=setTimeout(function(){return Ribs._readyToJump=!1},Ribs._jumpTimeout)},Ribs._makeJump=function(t){var n;Ribs._readyToJump=!1,clearTimeout(Ribs._jumpTimeout),n=Ribs._boundJumpKeys[t];if(n!=null&&n.length>0)return _.each(n,function(t){if(t.el==null||!e(t.el).is(":hidden"))return t.fn.apply(t.ctx)})},Ribs.bindJumpKey=function(e,t,n,r,i){var s,o;return s=t.charCodeAt(0),i==null&&r instanceof Backbone.View&&(i=r.el),(o=Ribs._boundJumpKeys)[s]||(o[s]=[]),Ribs._boundJumpKeys[s].push({label:e,fn:n,ctx:r,el:i,key:t}),s},Ribs.unbindJumpKey=function(e,t){var n;return n=e.charCodeAt(0),_.each(Ribs._boundJumpKeys[n],function(e,r){if(e.ctx===t){Ribs._boundJumpKeys[n].splice(r,1);if(Ribs._boundJumpKeys[n].length===0)return delete Ribs._boundJumpKeys[n]}})},Ribs._registeredListViews={},Ribs.showKeyboardBindings=function(){var t,n,r,i;return t="ribs-keyboard-shortcuts-overlay",e("."+t).remove(),r=e.el.div({"class":t}),i=e.el.ul(),e(r).append(e.el.h1("Navigation"),i),_.each(_.flatten(Ribs._boundJumpKeys),function(t){var n;if(!t.el||!e(t.el).is(":hidden"))return n=e.el.li({"class":"hotkey"},e.el.span({"class":"jump key"},"g"+t.key),e.el.span({"class":"action"},"Go to "+t.label)),e(i).append(n)}),n=[{key:"?",label:"Open this page"},{key:"j",label:"Next item"},{key:"J",label:"Last item"},{key:"k",label:"Previous item"},{key:"K",label:"First item"},{key:"x",label:"Select/deselect item"},{key:"X",label:"Select/deselect all"},{key:"_",label:"Expand/collapse list"},{key:"R",label:"Refresh items"}],_.each(n,function(t){var n;return n=e.el.li({"class":"hotkey"},e.el.span({"class":"key"},t.key),e.el.span({"class":"action"},t.label)),e(i).append(n)}),_.each(Ribs._registeredListViews,function(t){var n;if(!e(t.el).is(":hidden"))return n=e.el.h1(t.plural()),i=e.el.ul(),e(r).append(n,i),_.each(t.actions,function(t){var n;if(t.hotkey!=null)return n=e.el.li({"class":"hotkey"},e.el.span({"class":"key"},t.hotkey),e.el.span({"class":"action"},t.label)),e(i).append(n)})}),e(r).bind("click",function(){return e(r).remove(),!1}),e(window).bind("keyup",function(t){return t.which===27&&e(r).remove(),!1}),e("body").append(r),r},e(window).on("keypress",function(t){var n;if(!e(":focus").is("input:text, textarea")){n=Ribs._jumpPrefixKey.charCodeAt(0);if(t.which===n&&!Ribs._readyToJump)return Ribs._poiseJump();if(Ribs._readyToJump)return Ribs._makeJump(t.which);if(t.which===63)return Ribs.showKeyboardBindings()}}),Ribs.ListItem=function(r){function i(e){this.events||(this.events={}),_.extend(this.events,this._ribsEvents),i.__super__.constructor.call(this,e),this.view=e.view,this.model.on("change",this.render,this),this.model.on("remove",this.remove,this),this.model.on("stealfocus",this.stealfocus,this)}return t(i,r),i.prototype.tagName="li",i.prototype.className="item",i.prototype.attributes={tabindex:0},i.prototype._ribsEvents={click:"toggle",toggle:"toggle",select:"select",deselect:"deselect","click a":"stopPropogation",keypress:"keypressed"},i.prototype.render=function(){var t,r,i,s,o=this;return this.$el.empty(),this.$el.data("cid",this.model.cid),i=e.el.input({type:"checkbox",tabindex:-1}),this.$el.is(".selected")&&e(i).attr("checked",!0),this.$el.append(e.el.div({"class":"toggle"},i)),r=this.model.toJSON(),t=(s=this.view.displayAttributes)!=null?s:_.map(r,function(e,t){return{field:t}}),_.each(t,function(t){var i,s,u;return i=(u=t["class"])!=null?u:t.field,s=n(t.field,r),"map"in t&&(s=t.map(s)),o.$el.append(e.el.div({"class":i},s))}),_.each(this.view.inlineActions,function(e,t){return o.$el.append(e.renderInline(o))})},i.prototype.toggle=function(){if(!this.$el.is(".disabled"))return this.$el.is(".selected")?this.deselect():this.select()},i.prototype.stopPropogation=function(e){return e.stopImmediatePropagation()},i.prototype.select=function(e,t){t==null&&(t={}),this.$el.addClass("selected"),this.$el.find("input:checkbox").attr("checked","checked");if(!t.silent)return this.model.trigger("selected")},i.prototype.deselect=function(e,t){t==null&&(t={}),this.$el.removeClass("selected"),this.$el.find("input:checkbox").removeAttr("checked");if(!t.silent)return this.model.trigger("deselected")},i.prototype.enable=function(){return this.$el.removeClass("disabled"),this.$el.find("input:checkbox").removeAttr("disabled"),this.$el.attr("tabindex",0),this.model.trigger("enabled")},i.prototype.disable=function(){return this.$el.addClass("disabled"),this.$el.find("input:checkbox").attr("disabled","disabled"),this.$el.attr("tabindex",-1),this.model.trigger("disabled")},i.prototype.keypressed=function(e){var t;if((t=e.which)===13||t===120)return this.toggle();if(this.view.inlineActions.length)return e.originalEvent.listItem=this},i.prototype.stealfocus=function(){return this.$el.focus()},i}(Backbone.View),Ribs.List=function(r){function i(e){var t;this.sortArrows={},this.sortArrows[-1]="↓",this.sortArrows[1]="↑",this.events||(this.events={}),_.extend(this.events,this._ribsEvents),_.extend(this,e),t=_.uniqueId("ribs_view_"),Ribs._registeredListViews[t]=this,i.__super__.constructor.call(this,e),this.initializeTitle(),this.initializeActions(),this.initializeHeader(),this.initializeList(),this.initializeFooter(),this.addAllItems(),this.jumpkey!=null&&Ribs.bindJumpKey(this.plural(),this.jumpkey,function(){return this.$el.find(this.jumpSelector).focus()},this),this.collection.on("add",this.addItem,this),this.collection.on("reset",this.addAllItems,this),this.collection.on("selected deselected reset add remove",this.updateHeader,this),this.collection.on("selected deselected reset add remove",this.updateFooter,this)}return t(i,r),i.prototype.itemView=Ribs.ListItem,i.prototype.tagName="div",i.prototype.className="ribs",i.prototype.itemName="item",i.prototype._ribsEvents={keypress:"keypressed",focusin:"focusin",focusout:"focusout","click .header .toggle":"toggleSelected"},i.prototype.jumpSelector=".list li:first",i.prototype.focussed=!1,i.prototype.selectedByDefault=!1,i.prototype.stopPropogation=function(e){return e.preventDefault()},i.prototype.getSelected=function(){var t,n=this;return this.$list==null?[]:(t=this.$list.find(".item.selected").map(function(t,r){return n.collection.getByCid(e(r).data("cid"))}),t)},i.prototype.getNumSelected=function(){return this.$list==null?0:this.$list.find(".item.selected").size()},i.prototype.getNumTotal=function(){return this.collection==null?0:this.collection.length},i.prototype.toggleSelected=function(e){return this.selectedByDefault===!0?(this.$list.find(".item.selected").trigger("deselect",{silent:!0}),this.selectedByDefault=!1,this.collection.trigger("deselected")):(this.$list.find(".item:not(.selected)").trigger("select",{silent:!0}),this.selectedByDefault=!0,this.collection.trigger("selected"))},i.prototype.invertSelected=function(){var e,t;return t=this.$list.find(":not(.item.selected)"),e=this.$list.find(".item.selected"),t.trigger("select"),e.trigger("deselect")},i.prototype.toggleVisibility=function(){return this.$header.find(".maximize, .minimize").toggle(),this.$el.attr("class")==null&&this.$el.attr("class",""),this.$el.toggleClass("minimized",100)},i.prototype.sortBy=function(t,n){var r,i,s,o,u,a,f,l,c;return a=new RegExp(" ("+_.values(this.sortArrows).join("|")+")$|$"),r=(f=this.collection.sortingDirection[t])!=null?f:1,this.collection.trigger("sorted",t,r),n!=null&&(o=this.$header.find("[data-sort-by='"+n+"']"),u=(l=o.html())!=null?l.replace(a,""):void 0,e(o).html(u)),i=this.$header.find("[data-sort-by='"+t+"']"),s=(c=e(i).html())!=null?c.replace(a," "+this.sortArrows[r]):void 0,e(i).html(s)},i.prototype.sortCollectionBy=function(e){var t,r,i,s=this;r=this.collection.sortingBy,(i=this.collection).sortingDirection||(i.sortingDirection={}),this.collection.sortingBy=e,e===r&&e in this.collection.sortingDirection?this.collection.sortingDirection[e]*=-1:this.collection.sortingDirection[e]=1,t=this.collection.sortingDirection[e];if(this.collection.remoteSort)return;return this.collection.comparator=function(r,i){var s,o;s=n(e,r.toJSON()),o=n(e,i.toJSON());if(s===o)return 0;if(s>o||o==null)return 1*t;if(s<o||s==null)return-1*t},this.collection.sort(),this.sortBy(e,r)},i.prototype.keypressed=function(t){var n=this;if(!Ribs._readyToJump&&!e(":focus").is("input:text, textarea")){if(t.which===106)return e(":focus").nextAll(".item:not(.disabled):first").focus();if(t.which===107)return e(":focus").prevAll(".item:not(.disabled):first").focus();if(t.which===74)return this.$list.find(".item:last").focus();if(t.which===75)return this.$list.find(".item:first").focus();if(t.which===95)return this.toggleVisibility();if(t.which===88)return this.toggleSelected();if(t.which!==82)return this.trigger("keypressed",t);if(this.collection.url!=null)return this.collection.fetch({success:function(){var e;return(e=n.$list.find(":first"))!=null?e.focus():void 0}})}},i.prototype.focusin=function(e){return this.focussed||(this.focussed=!0),this.$el.addClass("focussed"),this.collection.trigger("focusin")},i.prototype.focusout=function(e){var t=this;if(this.focussed)return setTimeout(function(){return t.$el.find(document.activeElement).length===0&&t.$el.removeClass("focussed"),t.focussed=!1,t.collection.trigger("focusout")},10)},i.prototype.plural=function(){var e;return(e=this.itemNamePlural)!=null?e:this.itemName+"s"},i.prototype.initializeTitle=function(){var t,n;if(this.suppressTitle==null)return t=(n=this.title)!=null?n:this.plural(),this.$title=e(e.el.h1({"class":"title"},t)),this.$el.append(this.$title)},i.prototype.initializeActions=function(){var t=this;return this.$batchActions=e(e.el.ul({"class":"actions"})),this.$el.append(this.$batchActions),this.batchActions=[],this.inlineActions=[],_.each(this.actions,function(e){var n;e.collection=t.collection,e.view=t,n=new Ribs.Action(e),n.inline&&t.inlineActions.push(n);if(n.batch!==!1)return t.batchActions.push(n),n.render(),t.$batchActions.append(n.el)}),this.$batchActions},i.prototype.initializeList=function(){return this.$list=e(e.el.ul({"class":"list"})),this.$el.append(this.$list),this.$list},i.prototype.addAllItems=function(){return this.$list.empty(),this.collection.each(this.addItem,this)},i.prototype.addItem=function(e){var t;t=new this.itemView({model:e,view:this}),t.render(),this.$list.append(t.el);if(this.selectedByDefault)return t.$el.trigger("select")},i.prototype.initializeHeader=function(){var t,n,r=this;return this.$header=e(e.el.div({"class":"header"})),this.$el.append(this.$header),n=e.el.input({type:"checkbox",tabindex:-1}),this.selectedByDefault&&e(n).attr("checked","checked"),this.$header.append(e.el.div({"class":"toggle"},n)),this.displayAttributes!=null?t=this.displayAttributes:t=_.map(this.collection.first().toJSON(),function(e,t){return{field:t}}),_.each(t,function(t){var n,i,s,o;return i=(s=t.label)!=null?s:t.field,n=(o=t["class"])!=null?o:t.field,r.$header.append(e.el.div({"class":n,"data-sort-by":t.field},i))}),this.$header.find(".maximize, .minimize").click(function(){return r.toggleVisibility()}),this.$header.find("[data-sort-by]").click(function(t){var n;n=e(t.target).attr("data-sort-by");if(n!=null)return r.sortCollectionBy(n)}),this.$header.find("[data-sort-by="+this.collection.sortingBy+"]").append(" "+this.sortArrows[1]),this.$header},i.prototype.updateHeader=function(){var e,t,n,r,i;return r=this.getNumSelected(),n=this.getNumTotal(),r>=n&&(this.selectedByDefault=!0),r===0&&(this.selectedByDefault=!1),e=r!==0,t=e&&r<n,i=t?.5:1,this.$header.find(".toggle input").attr("checked",e).css("opacity",i)},i.prototype.initializeFooter=function(){return this.$footer=e(e.el.div({"class":"footer"})),this.$el.append(this.$footer),this.updateFooter(),this.$footer},i.prototype.updateFooter=function(){var e,t;return e=this.getNumTotal()!==1,t=e?this.plural():this.itemName,this.$footer.text(""+this.getNumSelected()+" / "+this.getNumTotal()+" "+t+" selected")},i}(Backbone.View),Ribs.Action=function(n){function r(e){this.min=1,this.max=-1,this.arity=null,this.check=null,this.events||(this.events={}),_.extend(this.events,this._ribsEvents),_.extend(this,e),r.__super__.constructor.call(this,e),this.collection!=null&&(this.collection.on("selected deselected reset",this.checkRequirements,this),this.hotkey!=null&&this.view.on("keypressed",this.keypressedOnView,this)),this.checkRequirements()}return t(r,n),r.prototype.tagName="li",r.prototype.className="action",r.prototype._ribsEvents={click:"triggerAction",keypress:"keypressedHere"},r.prototype.checkRequirements=function(){var e;e=this.allowed(),e||this.disable();if(e)return this.enable()},r.prototype.allowed=function(e){var t,n,r,i,s;return e||(e=this.view.getNumSelected()),n=!1,this.arity!=null?(t=this.arity,r=t===e,i=t===-1,s=!!(t%1)&&e>=Math.floor(t),n=r||i||s):(r=this.min===-1||e>=this.min,i=this.max===-1||e<=this.max,n=r&&i),n&&this.check!=null&&(n=this.check.apply(this.view,[this.collection.selected()])),n},r.prototype.disable=function(){return this.$el.addClass("disabled"),this.$el.find(".button").attr("tabindex",-1)},r.prototype.enable=function(){return this.$el.removeClass("disabled"),this.$el.find(".button").attr("tabindex",0)},r.prototype.triggerAction=function(e,t){if(!this.$el.is(".disabled")&&this.allowed())return this.activate.call(this.view,this.view.getSelected(),t)},r.prototype.triggerActionInline=function(e,t){if(!t.$el.is(".disabled"))return this.activate.call(this.view,[t.model],t)},r.prototype.keypressedHere=function(e){return e.which===13?(this.triggerAction(e),!1):!0},r.prototype.keypressedOnView=function(e){var t;if(this.hotkey!=null&&this.hotkey.charCodeAt(0)===e.which)return t=e.originalEvent.listItem,t!=null&&this.inline!=null?this.triggerActionInline(e,t):this.triggerAction(e,t),!1},r.prototype.render=function(){return this.$el.html(this.drawButton())},r.prototype.drawButton=function(t){var n,r,i,s,o;return t==null&&(t=!1),t||!this.$el.is(".disabled")?i=0:i=-1,n=e.el.div({"class":"button",tabindex:i}),t?r=(s=this.inlineLabel)!=null?s:this.label:(r=(o=this.batchLabel)!=null?o:this.label,this.hotkey!=null&&!this.inline&&(r=this.constructor.highlightHotkey(r,this.hotkey))),e(n).html(r),e(n).attr("title",this.label),e(n)},r.prototype.renderInline=function(t){var n,r=this;return n=this.drawButton(!0),n.addClass("inline"),e(n).on("click",function(e){return r.triggerActionInline(e,t),!1}),e(n).on("keypress",function(e){if(e.which===13)return r.triggerActionInline(e,t),!1}),n},r.highlightHotkey=function(e,t){var n,r;return n=t,r=e.replace(n,"<span class='hotkey'><strong>"+n+"</strong></span>"),e===r&&(r=""+e+" <span class='hotkey'>[<strong>"+n+"</strong>]</span>"),r},r}(Backbone.View),n=function(e,t){var n,r;n=e.split("."),r=t[n.shift()];while(r!=null&&n.length>0)t=r,r=t[n.shift()];return typeof r=="function"?r.apply(t):r}})(jQuery)}).call(this)