(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};(function(e){var n;return window.Ribs={},Ribs._boundJumpKeys={},Ribs._jumpPrefixKey="g",Ribs._jumpTimeout=1e3,Ribs._poiseJump=function(){return Ribs._readyToJump=!0,clearTimeout(Ribs._jumpInterval),Ribs._jumpInterval=setTimeout(function(){return Ribs._readyToJump=!1},Ribs._jumpTimeout)},Ribs._makeJump=function(t){var n;Ribs._readyToJump=!1,clearTimeout(Ribs._jumpTimeout),n=Ribs._boundJumpKeys[t];if(n!=null&&n.length>0)return _.each(n,function(t){if(t.el==null||!e(t.el).is(":hidden"))return t.fn.apply(t.ctx)})},Ribs.bindJumpKey=function(e,t,n,r,i){var s,o;return s=t.charCodeAt(0),i==null&&r instanceof Backbone.View&&(i=r.el),(o=Ribs._boundJumpKeys)[s]||(o[s]=[]),Ribs._boundJumpKeys[s].push({label:e,fn:n,ctx:r,el:i,key:t}),s},Ribs.unbindJumpKey=function(e,t){var n;return n=e.charCodeAt(0),_.each(Ribs._boundJumpKeys[n],function(e,r){if(e.ctx===t){Ribs._boundJumpKeys[n].splice(r,1);if(Ribs._boundJumpKeys[n].length===0)return delete Ribs._boundJumpKeys[n]}})},Ribs._registeredListViews={},Ribs.showKeyboardBindings=function(){var t,n,r,i;return t="ribs-keyboard-shortcuts-overlay",e("."+t).remove(),r=e.el.div({"class":t}),i=e.el.ul(),e(r).append(e.el.h1("Navigation"),i),_.each(_.flatten(Ribs._boundJumpKeys),function(t){var n;if(!t.el||!e(t.el).is(":hidden"))return n=e.el.li({"class":"hotkey"},e.el.span({"class":"jump key"},"g"+t.key),e.el.span({"class":"action"},"Go to "+t.label)),e(i).append(n)}),n=[{key:"?",label:"Open this page"},{key:"j",label:"Next item"},{key:"J",label:"Last item"},{key:"k",label:"Previous item"},{key:"K",label:"First item"},{key:"x",label:"Select/deselect item"},{key:"X",label:"Select/deselect all"},{key:"_",label:"Expand/collapse list"},{key:"R",label:"Refresh items"}],_.each(n,function(t){var n;return n=e.el.li({"class":"hotkey"},e.el.span({"class":"key"},t.key),e.el.span({"class":"action"},t.label)),e(i).append(n)}),_.each(Ribs._registeredListViews,function(t){var n;if(!e(t.el).is(":hidden"))return n=e.el.h1(t.plural()),i=e.el.ul(),e(r).append(n,i),_.each(t.actions,function(t){var n;if(t.hotkey!=null)return n=e.el.li({"class":"hotkey"},e.el.span({"class":"key"},t.hotkey),e.el.span({"class":"action"},t.label)),e(i).append(n)})}),e(r).bind("click",function(){return e(r).remove(),!1}),e(window).bind("keyup",function(t){return t.which===27&&e(r).remove(),!1}),e("body").append(r),r},e(window).on("keypress",function(t){var n;if(!e(document.activeElement).is("input:text, textarea")){n=Ribs._jumpPrefixKey.charCodeAt(0);if(t.which===n&&!Ribs._readyToJump)return Ribs._poiseJump();if(Ribs._readyToJump)return Ribs._makeJump(t.which);if(t.which===63)return Ribs.showKeyboardBindings()}}),Ribs.ListItem=function(n){function r(e){var t=this;this.events||(this.events={}),_.extend(this.events,this._ribsEvents),this.view=e!=null?e.view:void 0,this.listItemCells=[],_.each(this.view.displayAttributes,function(n){return n=_.clone(n),n.view=t,n.model=e.model,t.listItemCells.push(new Ribs.ListItemCell(n))}),r.__super__.constructor.call(this,e),this.model!=null&&(this.model.on("change",this.render,this),this.model.on("remove",this.remove,this),this.model.on("stealfocus",this.stealfocus,this))}return t(r,n),r.prototype.tagName="li",r.prototype.className="item",r.prototype.attributes={tabindex:0},r.prototype._ribsEvents={click:"toggle",toggle:"toggle",select:"select",deselect:"deselect","click a":"stopPropogation",keypress:"keypressed"},r.prototype.render=function(){var t,n,r=this;this.$el.empty();if(!this.model)return;return this.$el.data("cid",this.model.cid),this.view.suppressToggle||(n=e.el.input({type:"checkbox",tabindex:-1}),this.$el.is(".selected")&&e(n).attr("checked",!0),this.$el.append(e.el.div({"class":"toggle"},n))),_.each(this.listItemCells,function(e){return e.render(),e.delegateEvents(),r.$el.append(e.el)}),t=this.model.toJSON(),_.each(this.view.inlineActions,function(e,t){if(e.filter==null||e.filter(r.model)!==!1)return r.$el.append(e.renderInline(r))})},r.prototype.toggle=function(){if(!this.$el.is(".disabled")&&!this.view.suppressToggle)return this.$el.is(".selected")?this.deselect():this.select()},r.prototype.stopPropogation=function(e){return e.stopImmediatePropagation()},r.prototype.select=function(e,t){t==null&&(t={});if(this.view.suppressToggle)return;this.$el.addClass("selected"),this.$el.find("input:checkbox").attr("checked","checked");if(!t.silent)return this.model.trigger("selected")},r.prototype.deselect=function(e,t){t==null&&(t={});if(this.view.suppressToggle)return;this.$el.removeClass("selected"),this.$el.find("input:checkbox").removeAttr("checked");if(!t.silent)return this.model.trigger("deselected")},r.prototype.enable=function(){return this.$el.removeClass("disabled"),this.$el.find("input:checkbox").removeAttr("disabled"),this.$el.attr("tabindex",0),this.model.trigger("enabled")},r.prototype.disable=function(){return this.$el.addClass("disabled"),this.$el.find("input:checkbox").attr("disabled","disabled"),this.$el.attr("tabindex",-1),this.model.trigger("disabled")},r.prototype.remove=function(){return this.deselect(),r.__super__.remove.call(this)},r.prototype.keypressed=function(t){var n;if(!Ribs._readyToJump&&!e(document.activeElement).is("input:text, textarea")){if(((n=t.which)===13||n===120)&&!this.view.suppressToggle){this.toggle();return}if(this.view.inlineActions.length)return t.originalEvent.listItem=this}},r.prototype.stealfocus=function(){return this.$el.focus()},r}(Backbone.View),Ribs.ListItemCell=function(r){function i(e){var t;this.events||(this.events={}),_.extend(this.events,this._ribsEvents),_.extend(this,e),i.__super__.constructor.call(this,e),this.$el.addClass((t=this.options["class"])!=null?t:this.options.field),this.model.on("change change:"+this.options.field,this.render,this)}return t(i,r),i.prototype.tagName="div",i.prototype.className="cell",i.prototype._ribsEvents={"click .edit":"edit","blur .editableField":"saveEditedField"},i.prototype.renderableValue=function(e){var t;return t=this.model.get(this.options.field),t||(t=n(this.options.field,this.model.toJSON())),this.options.map!=null&&!e&&(t=this.options.map(t,this.model,this.$el)),t},i.prototype.render=function(){var t,n,r,i;return this.$el.empty(),this.options.escape?this.$el.text(this.renderableValue()):this.$el.html(this.renderableValue()),this.editable&&(n=(r=this.options.label)!=null?r:this.options.field,t=e.el.span({"class":"edit button inline",title:"Edit "+n},"✎"),(i=this.model.get(this.options.field))===null||i===""?e(t).addClass("show"):e(t).removeClass("show"),this.$el.append(t)),this},i.prototype.edit=function(){var t;return this.options.editable&&(this.options.editable instanceof Function?t=this.options.editable.call(this,this.renderableValue(!0),this.model):t=e.el.input({type:"text",value:this.renderableValue(!0)}),t&&(e(t).addClass("editableField"),this.$el.html(t),this.delegateEvents(),e(t).focus(),this.model.editing=!0)),!1},i.prototype.saveEditedField=function(t){var n,r;r=e(t.target),n={},n[this.options.field]=r.val(),this.model.changeSet=n;try{this.model.save(n,{wait:!0})}catch(t){this.render()}return this.model.hasChanged()||this.model.trigger("change:"+this.options.field),this.model.editing=!1},i}(Backbone.View),Ribs.List=function(r){function i(e){var t,n=this;this.sortArrows={},this.sortArrows[-1]="↓",this.sortArrows[1]="↑",this.className||(this.className=""),this.className+=" ribs",this.events||(this.events={}),_.extend(this.events,this._ribsEvents),_.extend(this,e),t=_.uniqueId("ribs_view_"),Ribs._registeredListViews[t]=this,this.components=[],_.each(this.renderOrder,function(e){var t;t=e.replace(/^./,"$"+e[0].toLowerCase()),n["suppress"+e]||(n[t]=n["initialize"+e]());if(t in n)return n.components.push(n[t])}),i.__super__.constructor.call(this,e),this.jumpkey!=null&&Ribs.bindJumpKey(this.plural(),this.jumpkey,function(){return this.$el.find(this.jumpSelector).focus()},this),this.on("refresh",this.refresh),this.$el.addClass("ribs"),this.build()}return t(i,r),i.prototype.itemView=Ribs.ListItem,i.prototype.tagName="div",i.prototype.itemName="item",i.prototype._ribsEvents={keypress:"keypressed",focusin:"focusin",focusout:"focusout","click .header .toggle":"toggleSelected","click .maximize .minimize":"toggleVisibility","click [data-sort-by]":"sortByField"},i.prototype.jumpSelector=".list li:first",i.prototype.focussed=!1,i.prototype.selectedByDefault=!1,i.prototype.stopPropogation=function(e){return e.preventDefault()},i.prototype.renderOrder=["Title","Actions","Header","List","Footer"],i.prototype.build=function(){var e=this;this.$el.empty(),_.each(this.components,function(t){return e.$el.append(t)}),this._subviews=[];if(this.collection!=null)return this.setCollection(this.collection)},i.prototype.render=function(){_.each(this._subviews,function(e,t){return e.render()}),this.$footer&&this.updateFooter;if(this.$header)return this.updateHeader},i.prototype.setCollection=function(e){var t=this;return this.collection=e,_.each(this.allActions,function(e){if(e!=null)return e.setCollection(t.collection)}),this.collection.off("selected deselected reset add remove",null,this),this.collection.on("add",this.addItem,this),this.collection.on("reset",this.addAllItems,this),this.$header&&this.collection.on("selected deselected reset add remove",this.updateHeader,this),this.$footer&&this.collection.on("selected deselected reset add remove",this.updateFooter,this),this.addAllItems()},i.prototype.getSelected=function(){var t=this;return this.$list==null?[]:this.$list.find(".item.selected").map(function(n,r){return t.collection.getByCid(e(r).data("cid"))})},i.prototype.getDeselected=function(){var t=this;return this.$list==null?[]:this.$list.find(".item:not(.selected)").map(function(n,r){return t.collection.getByCid(e(r).data("cid"))})},i.prototype.getNumSelected=function(){return this.$list==null?0:this.$list.find(".item.selected").size()},i.prototype.getNumDeselected=function(){return this.$list==null?0:this.$list.find(".item:not(.selected)").size()},i.prototype.getNumTotal=function(){return this.collection==null?0:this.collection.length},i.prototype.toggleSelected=function(e){var t,n;return this.selectedByDefault===!0?(this.$list.find(".item.selected").trigger("deselect",{silent:!0}),this.selectedByDefault=!1,(t=this.collection)!=null?t.trigger("deselected"):void 0):(this.$list.find(".item:not(.selected)").trigger("select",{silent:!0}),this.selectedByDefault=!0,(n=this.collection)!=null?n.trigger("selected"):void 0)},i.prototype.invertSelected=function(){var e,t;return t=this.$list.find(":not(.item.selected)"),e=this.$list.find(".item.selected"),t.trigger("select"),e.trigger("deselect")},i.prototype.toggleVisibility=function(){return this.$header.find(".maximize, .minimize").toggle(),this.$el.attr("class")==null&&this.$el.attr("class",""),this.$el.toggleClass("minimized",100)},i.prototype.sortByField=function(t){var n,r,i;r=e(t.target).attr("data-sort-by");if(r!=null)return i=this.sortingBy,this.sortingDirection||(this.sortingDirection={}),this.sortingBy=r,r===i&&r in this.sortingDirection?this.sortingDirection[r]*=-1:this.sortingDirection[r]=1,n=this.sortingDirection[r],this.sortCollection(r,n),this.updateHeaderArrows(r,i)},i.prototype.sortCollection=function(e,t){var r=this;return this.collection.remoteSort?this.collection.trigger("remoteSort",e,t):(this.collection.comparator=function(i,s){var o,u,a,f;o=i.get(e),o||(o=n(e,i.toJSON())),a=r.displayAttributeMap[e],a.map!=null&&(o=a.map(o)),u=s.get(e),u||(u=n(e,s.toJSON())),f=r.displayAttributeMap[e],f.map!=null&&(u=f.map(u)),(o!=null?o.toLowerCase:void 0)!=null&&(o=o.toLowerCase()),(u!=null?u.toLowerCase:void 0)!=null&&(u=u.toLowerCase());if(o===u)return 0;if(o>u||u==null)return 1*t;if(o<u||o==null)return-1*t},this.collection.sort())},i.prototype.updateHeaderArrows=function(t,n){var r,i,s,o,u,a,f,l,c;if(this.collection==null)return;return a=new RegExp(" ("+_.values(this.sortArrows).join("|")+")$|$"),r=(f=this.sortingDirection[t])!=null?f:1,n!=null&&(o=this.$header.find("[data-sort-by='"+n+"']"),u=(l=o.html())!=null?l.replace(a,""):void 0,e(o).html(u)),i=this.$header.find("[data-sort-by='"+t+"']"),s=(c=e(i).html())!=null?c.replace(a," "+this.sortArrows[r]):void 0,e(i).html(s)},i.prototype.keypressed=function(t){if(!Ribs._readyToJump&&!e(document.activeElement).is("input:text, textarea"))return t.which===106?e(document.activeElement).nextAll(".item:visible:not(.disabled):first").focus():t.which===107?e(document.activeElement).prevAll(".item:visible:not(.disabled):first").focus():t.which===74?this.$list.find(".item:last").focus():t.which===75?this.$list.find(".item:first").focus():t.which===95?this.toggleVisibility():t.which===88?this.toggleSelected():t.which===82?(this.collection.trigger("before:refresh"),this.trigger("refresh")):this.trigger("keypressed",t)},i.prototype.refresh=function(){var e=this;if(this.collection.url!=null)return this.collection.fetch({success:function(){var t;return(t=e.$list.find(".item:first"))!=null?t.focus():void 0}})},i.prototype.focusin=function(e){var t;return this.focussed||(this.focussed=!0),this.$el.addClass("focussed"),(t=this.collection)!=null?t.trigger("focusin"):void 0},i.prototype.focusout=function(e){var t=this;if(this.focussed)return setTimeout(function(){var e;return t.$el.find(document.activeElement).length===0&&t.$el.removeClass("focussed"),t.focussed=!1,(e=t.collection)!=null?e.trigger("focusout"):void 0},10)},i.prototype.plural=function(){var e;return(e=this.itemNamePlural)!=null?e:this.itemName+"s"},i.prototype.initializeTitle=function(){var t,n,r;return n=(r=this.title)!=null?r:this.plural(),n instanceof Function&&(n=n.call(this)),t=e(e.el.h1({"class":"title"},n)),t},i.prototype.initializeActions=function(){var t,n=this;return this.batchActions=[],this.inlineActions=[],this.allActions=[],t=e(e.el.ul({"class":"actions"})),_.each(this.actions,function(e){var r;return e.collection=n.collection,e.view=n,r=new Ribs.Action(e),r.inline&&n.inlineActions.push(r),r.batch!==!1&&(n.batchActions.push(r),r.render(),t.append(r.el)),n.allActions.push(r)}),this.batchActions.length?t:null},i.prototype.initializeList=function(){var t;return t=e(e.el.ul({"class":"list"})),t},i.prototype.addItem=function(e){var t,n,r,i;Backbone.View.prototype.isPrototypeOf(this.itemView.prototype)?n=this.itemView:n=this.itemView(e),r=new n({model:e,view:this}),t=this.collection.indexOf(e),(i=this.$list.children().size())===0||i===t?this.$list.append(r.el):this.$list.children(":nth-child("+(t+1)+")").before(r.el),r.delegateEvents(),this.$el.is(":visible")&&r.render(),this._subviews.push(r);if(this.selectedByDefault)return r.select()},i.prototype.addAllItems=function(){var e;return this._subviews=[],this.$list.empty(),(e=this.collection)!=null&&e.each(this.addItem,this),this.trigger("rendered")},i.prototype.get=function(e){return _.find(this._subviews,function(t){return t.model.id===e})},i.prototype.getByCid=function(e){return _.find(this._subviews,function(t){return t.model.cid===e})},i.prototype.initializeHeader=function(){var t,n,r,i=this;return t=e(e.el.div({"class":"header"})),this.suppressToggle||(r=e.el.input({type:"checkbox",tabindex:-1}),this.selectedByDefault&&e(r).attr("checked","checked"),t.append(e.el.div({"class":"toggle"},r))),this.displayAttributes==null&&(n=_.map(this.collection.first().toJSON(),function(e,t){return{field:t}})),this.displayAttributeMap={},_.each(this.displayAttributes,function(n){var r,s,o,u;return i.displayAttributeMap[n.field]=n,s=(o=n.label)!=null?o:n.field,r=(u=n["class"])!=null?u:n.field,t.append(e.el.div({"class":r,"data-sort-by":n.sortField||n.field},s))}),t.find(".maximize, .minimize").click(function(){return i.toggleVisibility()}),t.find("[data-sort-by="+this.sortingBy+"]").append(" "+this.sortArrows[1]),t},i.prototype.updateHeader=function(){var e,t,n,r,i;return r=this.getNumSelected(),n=this.getNumTotal(),r>=n&&(this.selectedByDefault=!0),r===0&&(this.selectedByDefault=!1),e=r!==0,t=e&&r<n,i=t?.5:1,this.$header.find(".toggle input").attr("checked",e).css("opacity",i)},i.prototype.initializeFooter=function(){var t;return t=e(e.el.div({"class":"footer"})),t},i.prototype.updateFooter=function(){var e,t;return e=this.getNumTotal()!==1,t=e?this.plural():this.itemName,this.$footer.text(""+this.getNumSelected()+" / "+this.getNumTotal()+" "+t+" selected")},i}(Backbone.View),Ribs.Action=function(n){function r(e){this.min=1,this.max=-1,this.arity=null,this.check=null,this.events||(this.events={}),_.extend(this.events,this._ribsEvents),_.extend(this,e),r.__super__.constructor.call(this,e),this.collection!=null&&this.setCollection(this.collection),this.hotkey!=null&&this.view.on("keypressed",this.keypressedOnView,this),this.checkRequirements()}return t(r,n),r.prototype.tagName="li",r.prototype.className="action",r.prototype._ribsEvents={click:"triggerAction",keypress:"keypressedHere"},r.prototype.setCollection=function(e){if(e!=null)return this.collection=e,this.collection.off("selected deselected reset",null,this),this.collection.on("selected deselected reset",this.checkRequirements,this)},r.prototype.checkRequirements=function(){var e;e=this.allowed(),e||this.disable();if(e)return this.enable()},r.prototype.allowed=function(e){var t,n,r,i,s;return e||(e=this.view.getNumSelected()),n=!1,this.arity!=null?(t=this.arity,r=t===e,i=t===-1,s=!!(t%1)&&e>=Math.floor(t),n=r||i||s):(r=this.min===-1||e>=this.min,i=this.max===-1||e<=this.max,n=r&&i),n&&this.check!=null&&(n=this.check.apply(this.view,[this.view.getSelected()])),n},r.prototype.disable=function(){return this.$el.addClass("disabled"),this.$el.find(".button").attr("tabindex",-1)},r.prototype.enable=function(){return this.$el.removeClass("disabled"),this.$el.find(".button").attr("tabindex",0)},r.prototype.triggerAction=function(e,t){if(!this.$el.is(".disabled")&&this.allowed())return this.activate.call(this.view,this.view.getSelected(),t)},r.prototype.triggerActionInline=function(e,t){if(!t.$el.is(".disabled"))return this.activate.call(this.view,[t.model],t)},r.prototype.keypressedHere=function(e){return e.which===13?(this.triggerAction(e),!1):!0},r.prototype.keypressedOnView=function(e){var t;if(this.hotkey!=null&&this.hotkey.charCodeAt(0)===e.which)return t=e.originalEvent.listItem,t!=null&&this.inline!=null?this.triggerActionInline(e,t):this.triggerAction(e,t),!1},r.prototype.render=function(){return this.$el.html(this.drawButton())},r.prototype.drawButton=function(t,n){var r,i,s,o,u;return t==null&&(t=!1),t||!this.$el.is(".disabled")?s=0:s=-1,r=e.el.div({"class":"button",tabindex:s}),t?(i=(o=this.inlineLabel)!=null?o:this.label,n!=null&&i instanceof Function&&(i=i.call(this,n.model))):(i=(u=this.batchLabel)!=null?u:this.label,this.hotkey!=null&&(i=this.constructor.highlightHotkey(i,this.hotkey))),e(r).html(i),e(r).attr("title",this.label),e(r)},r.prototype.renderInline=function(t){var n,r=this;return n=this.drawButton(!0,t),n.addClass("inline"),e(n).on("click",function(e){return r.triggerActionInline(e,t),!1}),e(n).on("keypress",function(e){if(e.which===13)return r.triggerActionInline(e,t),!1}),n},r.highlightHotkey=function(e,t){var n,r;return n=t,r=e.replace(n,"<span class='hotkey'><strong>"+n+"</strong></span>"),e===r&&(r=""+e+" <span class='hotkey'>[<strong>"+n+"</strong>]</span>"),r},r}(Backbone.View),n=function(e,t){var n,r;n=e.split("."),r=t[n.shift()];while(r!=null&&n.length>0)t=r,r=t[n.shift()];return typeof r=="function"?r.apply(t):r}})(jQuery)}).call(this)